#!/bin/bash

D=`realpath $0`
cd `dirname ${D}`/..

MAX_START_WAIT=180

export EVA_DIR=`pwd`
if [ ! -f ./etc/eva_servers ]; then
    echo "${EVA_DIR}/etc/eva_servers missing"
    exit 2
fi
source ./etc/eva_servers

function start_controller() {
    ./sbin/$1-control start
    I=0
    sleep 0.5
    ./sbin/eva-tinyapi -C $1 -F test > /dev/null 2>&1
    R=$?
    if [ $R -eq 9 ]; then
        echo " configs missing!"
        return 1
    fi
    echo -n "$1: ." | tr "a-z" "A-Z"
    while [ $R -ne 0 ]; do
        if [ $I -gt ${MAX_START_WAIT} ]; then
            echo " failed to start!"
            return 2
        fi
        I=`expr $I + 1`
        sleep 0.5
        echo -n "."
        ./sbin/eva-tinyapi -C $1 -F test > /dev/null 2>&1
        R=$?
    done
    echo " started"
    return 0
}

case $1 in
start)
    echo 'Starting EVA'
    [ "x${UC_ENABLED}" == "xyes" ] && (start_controller uc || exit 1)
    [ "x${LM_ENABLED}" == "xyes" ] && (start_controller lm || exit 1)
    [ "x${SFA_ENABLED}" == "xyes" ] && (start_controller sfa || exit 1)
    ;;
stop)
    echo 'Stopping EVA'
    [ "x${SFA_ENABLED}" == "xyes" ] && ./sbin/sfa-control stop
    [ "x${LM_ENABLED}" == "xyes" ] && ./sbin/lm-control stop
    [ "x${UC_ENABLED}" == "xyes" ] && ./sbin/uc-control stop
    exit 0
    ;;
restart)
    ./sbin/eva-control stop $2
    ./sbin/eva-control start $2
    exit 0
    ;;
status)
    [ "x${UC_ENABLED}" == "xyes" ] && (echo -n "UC: "; ./sbin/uc-control status)
    [ "x${LM_ENABLED}" == "xyes" ] && (echo -n "LM: "; ./sbin/lm-control status)
    [ "x${SFA_ENABLED}" == "xyes" ] && (echo -n "SFA: "; ./sbin/sfa-control status)
    ;;
*)
    echo "Usage: eva-control start|stop|restart"
    exit 1
esac
exit 0
