<html>
 <head>
   <title>Plant1 interface</title>
   <script src="lib/jquery.min.js"></script>
   <script src="js/eva_sfa.js"></script>
<style type="text/css">
#logr {
    outline: none;
    width: 100%;
    height: 60% !important;
    font-size: 11px;
    overflow: scroll;
    overflow-x: hidden;
    margin-bottom: 10px;
    border-style : Solid;
    border-color : #3ab0ea;
    border-color : rgba(58, 176, 234, 1);
    border-width : 2px;
    border-radius : 5px;
    -moz-border-radius : 5px;
    -webkit-border-radius : 5px;
    }
.logentry.logentry_color_10 { color: grey }
.logentry.logentry_color_20 { color: black }
.logentry.logentry_color_30 {
    color: orange;
    font-weight: bold;
    font-size: 14px
}
.logentry.logentry_color_40 {
    color: red;
    font-weight: bold;
    font-size: 16px
}
.logentry.logentry_color_50 {
    color: red;
    font-weight: bold;
    font-size: 20px;
    animation: blinker 0.5s linear infinite;
}
@keyframes blinker {  
  50% { opacity: 0; }
}
</style>
 </head>
 <body>
     <div id="s_lvar__nogroup__timer1"></div>
     <div id="v_lvar__nogroup__timer1"></div>
     <div id="timer" style="width: 300px; border: 1px solid black; background-color: #336699; color: white"></div>
    <script type="text/javascript">
        au = ''

        function vclear() {
            eva_sfa_clear('nogroup/timer1');
        }

        function reset() {
            eva_sfa_reset('nogroup/timer1');
            eva_sfa_change_log_level(10);
        }

        function toggle() {
            eva_sfa_toggle('nogroup/timer1');
        }

        function action() {
            eva_sfa_action_toggle('nogroup/test', null, null, null, function(data) {
                //console.log(data);
                au = data.uuid;
                console.log(au);
            });
        }

        function escapeOID(oid) {
            var r = oid;
            r = r.replace(/[:\/]/g, '__');
            return r;
        }

        function show_expires() {
            var t = eva_sfa_expires_in('nogroup/timer1');
            if (t === undefined || t == null) {
                $('#timer').html('');
            } else {
                if (t == -2) {
                    $('#timer').html('STOPPED');
                    $('#timer').width(300);
                    $('#timer').css('background-color','grey');
                    $('#timer').css('color','white');
                } else if (t == -1 ) {
                    $('#timer').html('FINISHED');
                    $('#timer').width(300);
                    $('#timer').css('background-color','#99CCFF');
                    $('#timer').css('color','black');
                } else {
                    t = Number(Math.round(t * 10) / 10).toFixed(1);
                    $('#timer').css('background-color','#336699');
                    $('#timer').css('color','white');
                    $('#timer').width(t * 30);
                    $('#timer').html(t);
                }
            }
        }

        function result() {
//            eva_sfa_result_by_uuid(au, function(data) { console.log(data) } );
            eva_sfa_result('nogroup/test', null, 'R', function(data) { console.log(data) } );
        }

        function time_converter(UNIX_timestamp) {
          var a = new Date(UNIX_timestamp * 1000);
          var year = a.getFullYear();
          var month = a.getMonth() + 1;
          var date = a.getDate();
          var hour = a.getHours();
          var min = a.getMinutes();
          var sec = a.getSeconds();
          var time =
            year +
            '-' +
            pad(month, 2) +
            '-' +
            pad(date, 2) +
            ' ' +
            pad(hour, 2) +
            ':' +
            pad(min, 2) +
            ':' +
            pad(sec, 2);
          return time;
        }

        function pad(num, size) {
          var s = num + '';
          while (s.length < size) s = '0' + s;
          return s;
        }

        function format_log_record(l) {
          return (
            '<div class="logentry logentry_color_' +
            l.l +
            '">' +
            time_converter(l.t) +
            ' ' +
            l.h +
            ' ' +
            l.p +
            ' ' +
            eva_sfa_log_level_name(l.l) +
            ' ' +
            l.mod +
            ' ' +
            l.th +
            ': ' +
            l.msg +
            '</div>'
          );
        }

        eva_sfa_process_log_record = function(l) {
          $('#logr').append(format_log_record(l));
          while ($('.logentry').length > eva_sfa_log_records_max) {
          $('#logr')
            .find('.logentry')
            .first()
            .remove();
          }
        }

        eva_sfa_log_postprocess = function() {
          $('#logr').scrollTop($('#logr').prop('scrollHeight'));
        }

        setInterval(show_expires, 200);
        eva_sfa_init();
        eva_sfa_apikey="b413b012d148512923977e18077ac68c8b0f7c2195c1bbc0d1f95401d099a86f";
        eva_sfa_register_update_state('lvar:nogroup/*', function(state) {
            //console.log(escapeOID(state.oid));
            var o = escapeOID(state.oid);
            $('#s_' + o ).html('S: ' + state.status);
            $('#v_' + o ).html('V: ' + state.value);
        });
        eva_sfa_cb_login_success = function(data) {
            console.log('engine started');
            eva_sfa_log_records_max = 50;
            eva_sfa_log_start(20);
//            eva_sfa_register_update_state('*nogroup*', function(state) {
 //               console.log('S: ' + state.oid + ' ' + state.status);
  //          });
            console.log(eva_sfa_server_info);
        }

        eva_sfa_cb_login_error = function() {
            console.log('failed to login');
        }
        //eva_sfa_ws_mode = false;
        eva_sfa_cb_states_loaded = function(data) {
            console.log('states loaded');
            console.log(data);
        }
        eva_sfa_start();
        eva_sfa_reload_handler = function() {
            console.log('asked me to reload');
            document.location='/ui/test.html';
        }
        
        function test() {
            var s = eva_sfa_state('*nogroup*');
            console.log(s);
        }
    </script>
    <br />
    <button onclick="vclear()">CLEAR</button>
    <button onclick="reset()">RESET</button>
    <button onclick="toggle()">TOGGLE</button>
    <button onclick="action()">ACTION</button>
    <button onclick="result()">RESULT</button>
    <button onclick="test()">TEST</button>
    <div id="logr"></div>
</body>
</html>
