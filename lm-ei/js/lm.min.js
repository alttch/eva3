function create_cookie(e,o,l){var t="";if(l){var a=new Date;a.setTime(a.getTime()+24*l*60*60*1e3),t="; expires="+a.toUTCString()}document.cookie=e+"="+o+t+"; path=/"}function read_cookie(e){for(var o=e+"=",l=document.cookie.split(";"),t=0;t<l.length;t++){for(var a=l[t];" "==a.charAt(0);)a=a.substring(1,a.length);if(0==a.indexOf(o))return a.substring(o.length,a.length)}return null}function erase_cookie(e){create_cookie(e,"",-1)}function show_toolbar(e){$.each(toolbars,function(o,l){l!=e&&$("#toolbar_"+l).hide()}),$("#toolbar_"+e).show()}function show_board(e){$.each(boards,function(o,l){l!=e&&$("#b_"+l).hide()}),$("#b_"+e).show()}function reset_lvar(e){$.getJSON("/lm-api/reset?k="+apikey+"&i="+e,function(o){"OK"==o.result||popup("error","ERROR","Reset command failed for "+e)})}function load_sys_info(){apikey&&$.getJSON("/lm-api/test?k="+apikey,function(e){tsdiff=(new Date).getTime()/1e3-e.time,"debug"in e&&e.debug!=debug_mode&&(debug_mode=e.debug,show_debug_info(),"db_update"in e&&show_db_save(e.db_update),"polldelay"in e&&$("#i_polldelay").html(", poll delay: "+e.polldelay+"s"))})}function redraw_lvar_state(e){for(a=-1;a<=1;a++)items[e].status!=a?$("#lname_"+e).removeClass("lvar_s"+a):$("#lname_"+e).addClass("lvar_s"+a);$("#lval_"+e).html(items[e].value),-1!=items[e].status&&"null"!=items[e].value&&$("#lval_expires_"+e).html(format_expire_time(items[e].set_time,items[e].expires))}function load_lvar_state(){apikey&&lvars_loaded&&$.getJSON("/lm-api/state?k="+apikey+"&g="+$("#s_lvar_group").val(),function(e){$.each(e,function(o){var l=e[o],t=e[o].id;t in items?items[t].status==l.status&&items[t].value==l.value&&items[t].set_time==l.set_time&&items[t].expires==l.expires||(items[t]=l,redraw_lvar_state(t)):load_lvar_data()})})}function update_lvar_timers(){$.each(items,function(o,l){-1!=l.status&&"null"!=l.value?(e=$("#lval_expires_"+o).html(),$.isNumeric(e)&&e>0&&(e=Math.round(10*(e-trInterval/1e3))/10,e<0&&(e=0),$("#lval_expires_"+o).html(Number(e).toFixed(1)))):(e=$("#lval_expires_"+o).html(),$.isNumeric(e)&&e>0&&$("#lval_expires_"+o).html(Number(0).toFixed(1)))})}function load_lvar_data(){apikey&&("lvars"==page&&(show_board("lvars"),load_animation("b_lvars")),$.getJSON("/lm-api/groups?k="+apikey+"&p=LV",function(e){$("#s_lvar_group").find("option").remove().end();var o=!1,l=!1;$.each(e,function(e,t){"nogroup"!=t?($("#s_lvar_group").append("<option>"+t+"</option"),l=!0):o=!0}),o&&$("#s_lvar_group").append('<option value="nogroup">no group</option'),l||o?("lvars"==page&&show_toolbar("lvars"),load_lvars()):$("#b_lvars").html('<div class="notavail">No LVars available</div>')}))}function set_lvar_state(e){var o=$("#lvar_status").val(),l=$("#lvar_value").val();$.getJSON("/lm-api/set?k="+apikey+"&i="+e+"&s="+o+"&v="+l,function(t){"OK"==t.result?(items[e].status=o,items[e].value=l,redraw_lvar_state(e)):popup("error","ERROR","Unit state not changed. Action result: "+t.status)})}function select_lvar_state(e){html='<form class="form-horizontal"><div class="form-group"><label class="col-xs-4 control-label" for="lvar_status">Status</label><div class="col-xs-6"><select class="form-control" id="lvar_status">',$.each(lvar_state_labels,function(o,l){html+='<option value="'+o+'"',o==items[e].status&&(html+=" selected"),html+=">"+l+"</option>"});var o=items[e].value;"null"==o&&(o=""),html+='</select></div></div><div class="form-group"><label class="col-xs-4 control-label"for="lvar_value">Value</label><div class="col-xs-6"><input class="form-control" type="text" size="5"id="lvar_value" value="'+o+'" /></div></div></form>',popup("confirm","SET STATE OF "+e,html,"SET","CANCEL",'set_lvar_state("'+e+'")')}function format_expire_time(e,o){var l=o-(new Date).getTime()/1e3+tsdiff+e;return l<0?"0.0":Number(Math.round(10*l)/10).toFixed(1)}function load_lvars(){$.getJSON("/lm-api/state?k="+apikey+"&full=1&g="+$("#s_lvar_group").val(),function(e){var o=1;$("#b_lvars").html(""),$.each(Object(e).sort(),function(l){var t=e[l].id,a=e[l];_lvar=$("<div />",{class:"col-xs-3"}),_lvar_expires=$("<div />",{class:"col-xs-2"}),_lvar_state=$("<div />",{class:"col-xs-3"}),$("<span />",{class:"lval",html:"E: "}).appendTo(_lvar_expires),$("<span />",{id:"lval_expires_"+t,class:"lval",html:format_expire_time(a.set_time,a.expires)}).appendTo(_lvar_expires),$("<span />",{class:"lval",html:"V="}).appendTo(_lvar_state),$("<span />",{id:"lval_"+t,class:"lval",html:a.value}).appendTo(_lvar_state),items[t]=a,_lvar_buttons=$("<div />",{class:"col-xs-4"}),$("<button />",{class:"st0",html:"SET"}).attr("onclick",'select_lvar_state("'+t+'")').appendTo(_lvar_buttons),a.expires>0&&$("<button />",{class:"st0",html:"RESET"}).attr("onclick",'reset_lvar("'+t+'")').appendTo(_lvar_buttons);var s=$("<div />",{class:"row row-device bg"+o}),n=t;$("<div />",{class:"device lvar_s"+a.status,id:"lname_"+t,html:n}).appendTo(_lvar),$("<div />",{class:"device-descr",html:a.description}).appendTo(_lvar),_lvar.appendTo(s),_lvar_expires.appendTo(s),_lvar_state.appendTo(s),_lvar_buttons.appendTo(s),s.appendTo("#b_lvars"),o=1==o?0:1}),lvars_loaded=!0})}function process_ws(e){data=JSON.parse(e.data),"state"==data.s&&$.each(data.d,function(e,o){if(e=o.id,p=o.type,e in items&&"lvar"==p){var l=items[e].value;items[e]=o,void 0==o.value&&(items[e].value=l),redraw_lvar_state(e)}}),"log"==data.s&&($.each(data.d,function(e,o){append_log_entry(log_record(o))}),log_autoscroll&&$("#logr").scrollTop($("#logr").prop("scrollHeight")))}function start_ws(e){if(apikey){var o,l=window.location;o="https:"===l.protocol?"wss:":"ws:",o+="//"+l.host,ws=new WebSocket(o+"/ws?k="+apikey),ws.onmessage=function(e){process_ws(e)},ws.onclose=function(){$("#i_connection").html('<b><span style="color: red">WS connecting</span></b>'),log_first_load=!0,lvars_loaded=!1,log_loaded=!1,setTimeout(function(){start_ws(!0)},3e3)},ws.addEventListener("open",function(o){$("#i_connection").html('<b><span style="color: green">instant</span></b>'),ws.send(JSON.stringify({s:"state"})),log_subscribed&&ws.send(JSON.stringify({s:"log"})),e&&(log_first_load=!0,login(apikey,!1,!1,!0))})}}function init_dashboard(e){$("#sysinfo").show(),show_toolbar("blank"),$("#controls").show(),$("#version_info").show(),e?"log"==page&&show_log():(items=new Object,show_lvars()),ws_mode?(e||($("#i_connection").html('<b><span style="color: red">WS connecting</span></b>'),start_ws(!1)),load_lvar_data()):($("#i_connection").html('<b><span style="color: orange">'+jrInterval/1e3+" sec</span></b>"),e||setInterval(load_lvar_state,jrInterval),load_lvar_data())}function set_debug_mode(e){$.getJSON("/sys-api/set_debug?k="+apikey+"&debug="+(e?"1":"0"),function(e){"OK"==e.result?(debug_mode=!debug_mode,show_debug_info(),popup("info","DEBUG","Debug mode is now "+(debug_mode?"enabled":"disabled"))):popup("error","ERROR","Debug mode not changed<br />Result: "+e.result)})}function save(){$.getJSON("/sys-api/save?k="+apikey,function(e){"OK"==e.result?popup("info","UPDATED","System data updated successfully"):popup("error","ERROR","Unable to update system data<br />Result: "+e.result)}).error(function(e){403!=e.status?popup("error","ERROR","Unable to update system data<br />UNKNOWN ERROR"):invalid_api_key()})}function show_debug_info(e){debug_mode?($("#i_debug").css("color","orange").css("font-weight","bold").html("Debug mode: ON"),master&&$("#i_debug").css("cursor","pointer").attr("onclick","set_debug_mode(false)")):($("#i_debug").css("color","#4D4D4D").css("font-weight","normal").html("Debug mode: OFF"),master&&$("#i_debug").css("cursor","pointer").attr("onclick","set_debug_mode(true)"))}function show_db_save(e){1==e?$("#i_dbsave").html(", db updates: instant"):2==e?$("#i_dbsave").html(", db updates: on exit"):$("#i_dbsave").html(", db updates: on request")}function disable_sys_func(){$("#tbtn_log").addClass("disabled").attr("onclick",null),$("#tbtn_save").addClass("disabled").attr("onclick",null)}function enable_sys_func(){$("#tbtn_log").removeClass("disabled").attr("onclick","safe_close_tool_menu();show_log()"),$("#tbtn_save").removeClass("disabled").attr("onclick","safe_close_tool_menu();save()")}function disable_master_func(){$("#tbtn_rules").addClass("disabled").attr("onclick",null)}function enable_master_func(){$("#tbtn_rules").removeClass("disabled").attr("onclick","safe_close_tool_menu();show_rules()")}function login(e,o,l,t){l&&(show_board("blank"),load_animation("b_blank")),$.getJSON("/lm-api/test?k="+e,function(a){apikey=e,l&&!t&&(o?create_cookie("apikey",e,7300):erase_cookie("apikey")),$("#i_system").html("<b>"+a.system+"</b>"),tsdiff=(new Date).getTime()/1e3-a.time,master=a.acl.master,$("#i_key").html("<b>"+a.acl.key_id+"</b>"),$("#i_master").html(a.acl.master?'<font color="red"><b>yes</b></font>':"no"),$("#i_version").html(a.version);var s="";"development"in a&&a.development&&(s=' <b><span style="color: red">DEVELOPMENT MODE</span>'),$("#i_build").html(a.product_build+s),"debug"in a&&($("#i_sysinfo").show(),debug_mode=a.debug,l&&debug_mode&&(log_level=10,$("#s_log_level").val(10)),show_debug_info()),"db_update"in a&&show_db_save(a.db_update),"polldelay"in a&&$("#i_polldelay").html(", poll delay: "+a.polldelay+"s"),(l||t)&&(a.acl.master||"sysfunc"in a.acl&&a.acl.sysfunc?enable_sys_func():disable_sys_func(),a.acl.master?enable_master_func():disable_master_func(),init_dashboard(t))}).error(function(e){403!=e.status?popup("error","UNABLE TO LOGIN","UNKNOWN ERROR"):invalid_api_key()})}function invalid_api_key(){popup("error","ACCESS DENIED","INVALID API KEY","OK","","show_login_form()","")}function show_lvars(){page="lvars",show_board("lvars"),lvars_loaded&&show_toolbar("lvars")}function show_login_form(){try{ws.onclose=null,ws.send(JSON.stringify({s:"bye"})),ws.close()}catch(e){}log_first_load=!0,lvars_loaded=!1,log_loaded=!1,$("#keyform").html(""),$("#b_lvars").html(""),$("#logr").html(""),$("#i_debug").html(""),$("#i_dbsave").html(""),$("#i_polldelay").html(""),$("#sysinfo").hide(),$("#i_sysinfo").hide(),$("#controls").hide(),$("#version_info").hide(),apikey="",$("#apikey").val(""),show_board("keyform");$("#keyform").append('<div><input class="st0 input" type="password" id="apikey" placeholder="API KEY" /></div><div style="width: 150px; margin-right: 60px"><input class="chBox" type="checkbox" onchange="perform_login()" id="apikey_remember" value="true"><label class="chk-settings" for="apikey_remember">remember API key</label></div>'),$("#apikey").on("keydown",function(e){13==e.which&&(perform_login(),e.preventDefault())}),$("#apikey").focus()}function perform_login(){var e=$("#apikey").val(),o=$("#apikey_remember").is(":checked");$("#keyform").html(""),login(e,o,!0,!1)}function logout(){safe_close_tool_menu(),erase_cookie("apikey"),show_login_form()}function load_log_entries(e,o){""!=apikey&&(ws_mode&&(lr2p=new Array),log_first_load&&load_animation("logr"),$.getJSON("/sys-api/log_get?l="+log_level+"&n="+max_log_records+"&k="+apikey,function(l){ws_mode&&log_first_load&&set_ws_log_level(log_level);var t="";$.each(l,function(e,o){t+=log_record(o)});var a=$("#logr");a.html(t),log_loaded||(log_loaded=!0,show_toolbar("log")),$.each(lr2p,function(e,o){a.append(o)}),(o||log_autoscroll)&&a.scrollTop(a.prop("scrollHeight")),(!ws_mode&&log_first_load||e)&&setTimeout(function(){load_log_entries(!0,!1)},lrInterval),log_first_load&&(log_first_load=!1)}).error(function(o){(!ws_mode&&log_first_load||e)&&setTimeout(function(){load_log_entries(!0,!1)},lrInterval)}))}function toggle_log_as(){log_autoscroll?($("#btn_log_as").removeClass("active"),log_autoscroll=!1):($("#btn_log_as").addClass("active"),log_autoscroll=!0)}function show_log(){page="log",show_board("log"),!ws_mode||log_first_load?(log_loaded=!1,show_toolbar("blank"),load_log_entries(!1,!0)):(show_toolbar("log"),log_autoscroll&&$("#logr").scrollTop($("#logr").prop("scrollHeight")))}function set_ws_log_level(e){ws_mode&&ws.send(JSON.stringify({s:"log",l:e})),log_subscribed=!0}function log_record(e){return'<div class="logentry logentry_color_'+e.l+'">'+time_converter(e.t)+" "+e.h+" "+e.p+" "+log_level_name[e.l]+" "+e.mod+" "+e.th+": "+e.msg+"</div>"}function append_log_entry(e){if(log_loaded)for($("#logr").append(e);$(".logentry").length>max_log_records;)$("#logr").find(".logentry").first().remove();else lr2p.push(e)}function ask_debug_mode(){master&&!debug_mode&&log_level<=10&&popup("confirm","Enable DEBUG","Server is not in the DEBUG MODE<br />Enable DEBUG?","YES","NO","set_debug_mode(true)","")}function popup(pclass,title,msg,btn1,btn2,btn1a,btn2a){$("#popup_header").removeClass(),$("#popup_header").addClass("popup_header"),$("#popup_header").addClass("popup_header_"+pclass),$("#popup_header").html(title),$("#popup_content").html(msg),$("#popup_btn_1").html(""),$("#popup_btn_2").html("");var btn1text="OK";btn1&&(btn1text=btn1);var btn1=$("<div />",{class:"popup_btn popup_btn_"+pclass,html:btn1text});if(btn1a?btn1.attr("onclick","close_popup();"+btn1a):btn1.attr("onclick","close_popup()"),btn1.appendTo($("#popup_btn_1")),btn2){var btn2=$("<div />",{class:"popup_btn popup_btn_"+pclass,html:btn2});btn2a?btn2.attr("onclick",btn2a):btn2.attr("onclick","close_popup()"),btn2.appendTo($("#popup_btn_2")),$("#popup_btn_1").removeClass(),$("#popup_btn_2").removeClass(),$("#popup_btn_1").addClass("col-xs-4"),$("#popup_btn_2").addClass("col-xs-4"),$("#popup_btn_2").show()}else $("#popup_btn_1").removeClass(),$("#popup_btn_1").addClass("col-xs-8"),$("#popup_btn_2").hide();safe_close_tool_menu(),$("#popup").show(),$(document).on("keydown",function(e){27==e.which&&(close_popup(),e.preventDefault()),13==e.which&&(close_popup(),eval(btn1a),e.preventDefault())})}function close_popup(){$(document).off("keydown"),$("#popup").hide()}function open_tool_menu(){$("#toolmenu_btn").hide(),$("#toolmenu").removeClass("hidden-xs hidden-sm"),$("#toolmenu").show(),toolmenu_opened=!0}function close_tool_menu(){$("#toolmenu").addClass("hidden-xs hidden-sm"),$("#toolmenu_btn").show(),toolmenu_opened=!1}function safe_close_tool_menu(){toolmenu_opened&&close_tool_menu()}function load_animation(e){$("#"+e).html('<div class="cssload-square"><div class="cssload-square-part cssload-square-green"></div><div class="cssload-square-part cssload-square-pink"></div><div class="cssload-square-blend"></div></div>')}function get_arg(e){url=window.location.href,e=e.replace(/[\[\]]/g,"\\$&");var o=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(url);return o?o[2]?decodeURIComponent(o[2].replace(/\+/g," ")):"":null}function pad(e,o){for(var l=e+"";l.length<o;)l="0"+l;return l}function time_converter(e){var o=new Date(1e3*e),l=o.getFullYear(),t=o.getMonth()+1,a=o.getDate(),s=o.getHours(),n=o.getMinutes(),r=o.getSeconds();return l+"-"+pad(t,2)+"-"+pad(a,2)+" "+pad(s,2)+":"+pad(n,2)+":"+pad(r,2)}var items=new Object,as_labels=new Object,master=!1,lvars_loaded=!1,log_loaded=!1,log_subscribed=!1,log_first_load=!0,log_level=20,log_autoscroll=!0,page="",toolmenu_opened=!1,max_log_records=100,debug_mode=!1,lvar_state_labels={"-1":"expired",0:"disabled",1:"enabled"},tsdiff=0,lr2p=new Array,toolbars=["blank","lvars","log"],boards=["blank","keyform","lvars","log"];setInterval(load_sys_info,srInterval),setInterval(update_lvar_timers,trInterval);var log_level_name={10:"DEBUG",20:"INFO",30:"WARNING",40:"ERROR",50:"CRITICAL"};
